# Data Model: RAG Chatbot for Digital Book Website

## Overview
This document outlines the data models for the RAG chatbot system, including entities, relationships, and validation rules based on the feature requirements.

## Core Entities

### Book Content
**Description**: Represents the digital book content that will be chunked and indexed for RAG functionality.

**Attributes**:
- `id`: String (unique identifier for the book)
- `title`: String (book title)
- `content`: String (raw Markdown content of the book)
- `format`: String (format of the content, e.g., "markdown")
- `created_at`: DateTime (timestamp when the book was indexed)
- `updated_at`: DateTime (timestamp when the book was last updated)

**Validation Rules**:
- `id` must be unique across all books
- `title` must not be empty
- `content` must be in the specified format

### Text Chunk
**Description**: Represents a segment of book content that has been processed and vectorized for retrieval.

**Attributes**:
- `id`: String (unique identifier for the chunk)
- `book_id`: String (reference to the parent book)
- `content`: String (text content of the chunk)
- `chunk_index`: Integer (order of the chunk in the book)
- `embedding`: Array<Float> (vector representation of the content)
- `metadata`: Object (additional information like page number, section)
- `created_at`: DateTime (timestamp when the chunk was created)

**Validation Rules**:
- `id` must be unique across all chunks
- `book_id` must reference an existing book
- `content` must not be empty
- `embedding` must be a valid vector of appropriate dimension
- `chunk_index` must be non-negative

### User Query
**Description**: Represents a question or query submitted by a user through the chatbot interface.

**Attributes**:
- `id`: String (unique identifier for the query)
- `session_id`: String (identifier for the conversation session)
- `query_text`: String (the actual question asked by the user)
- `embedding`: Array<Float> (vector representation of the query)
- `timestamp`: DateTime (when the query was submitted)
- `selected_text`: String (optional text that was highlighted by the user)

**Validation Rules**:
- `id` must be unique across all queries
- `query_text` must not be empty
- `embedding` must be a valid vector of appropriate dimension

### Retrieved Context
**Description**: Represents the book content chunks retrieved based on similarity to the user query.

**Attributes**:
- `id`: String (unique identifier for the retrieval result)
- `query_id`: String (reference to the original query)
- `chunk_id`: String (reference to the retrieved chunk)
- `similarity_score`: Float (similarity score between query and chunk)
- `rank`: Integer (rank of this chunk in the retrieval results)
- `content`: String (the content of the retrieved chunk)

**Validation Rules**:
- `query_id` must reference an existing query
- `chunk_id` must reference an existing chunk
- `similarity_score` must be between 0 and 1
- `rank` must be positive

### Chat Response
**Description**: Represents the response generated by the LLM based on the user query and retrieved context.

**Attributes**:
- `id`: String (unique identifier for the response)
- `query_id`: String (reference to the original query)
- `response_text`: String (the answer generated by the LLM)
- `source_chunks`: Array<String> (IDs of chunks used to generate the response)
- `timestamp`: DateTime (when the response was generated)
- `confidence`: Float (confidence score of the response)

**Validation Rules**:
- `query_id` must reference an existing query
- `response_text` must not be empty
- `confidence` must be between 0 and 1

### Conversation Session
**Description**: Represents a conversation session between a user and the chatbot.

**Attributes**:
- `id`: String (unique identifier for the session)
- `user_id`: String (identifier for the user, if available)
- `created_at`: DateTime (when the session started)
- `updated_at`: DateTime (when the session was last updated)
- `active`: Boolean (whether the session is currently active)

**Validation Rules**:
- `id` must be unique across all sessions
- `created_at` must be before `updated_at` if the session has been updated

## Relationships

```
Book Content (1) → (N) Text Chunk
Text Chunk (N) ← → (N) Retrieved Context
User Query (1) → (N) Retrieved Context
User Query (1) → (1) Chat Response
User Query (1) → (N) Conversation Session
```

## State Transitions

### Query Processing Flow
1. User submits a query (User Query created)
2. Query is embedded (User Query embedding generated)
3. Similar chunks are retrieved (Retrieved Context created)
4. LLM generates response (Chat Response created)
5. Response is returned to user

## API Schema Definitions

### Request Schemas

#### Query Request
```json
{
  "question": "string (required)",
  "selected_text": "string (optional)",
  "session_id": "string (optional)"
}
```

#### Embed Request
```json
{
  "text": "string (required)",
  "model": "string (optional, default: gemini-embedding)"
}
```

#### Search Request
```json
{
  "query_embedding": "array<float> (required)",
  "top_k": "integer (optional, default: 5)",
  "book_id": "string (optional)"
}
```

### Response Schemas

#### Query Response
```json
{
  "response": "string (required)",
  "source_chunks": "array<object> (optional)",
  "session_id": "string (required)",
  "confidence": "float (optional)"
}
```

#### Embed Response
```json
{
  "embedding": "array<float> (required)",
  "model": "string (required)"
}
```

#### Search Response
```json
{
  "results": "array<object> (required)",
  "count": "integer (required)"
}
```