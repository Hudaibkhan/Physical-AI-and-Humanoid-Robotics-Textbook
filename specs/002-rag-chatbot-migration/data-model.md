# Data Model: RAG Chatbot Integration Fix + Agent SDK Migration

**Feature**: RAG Chatbot Integration Fix + Agent SDK Migration
**Date**: 2025-12-10
**Status**: Draft

## Overview

This document defines the data models for the RAG chatbot system that integrates OpenAI Agent SDK, Qdrant vector database, Cohere embeddings, and Gemini API.

## Entity Models

### 1. BookContentChunk

**Description**: Represents a chunk of textbook content with its embedding vector for RAG retrieval

**Fields**:
- `id`: string (primary key, Qdrant point ID)
- `content`: string (the actual text content of the chunk)
- `embedding`: float[1024] (Cohere embedding vector)
- `source_file`: string (path to the original markdown file)
- `chunk_index`: integer (position of this chunk in the original document)
- `chunk_start_pos`: integer (starting character position in source file)
- `chunk_end_pos`: integer (ending character position in source file)
- `metadata`: object (additional information like chapter, section, etc.)
- `created_at`: datetime (timestamp when chunk was created)
- `updated_at`: datetime (timestamp when chunk was last updated)

**Validation Rules**:
- `content` must not be empty
- `embedding` must be exactly 1024 elements (Cohere dimension)
- `source_file` must be a valid path
- `chunk_index` must be non-negative

**Relationships**:
- Belongs to one `SourceDocument` (via `source_file`)
- Referenced by multiple `ChatQueries` (through similarity search)

### 2. SourceDocument

**Description**: Represents the original markdown documents that are chunked and embedded

**Fields**:
- `id`: string (primary key, derived from file path)
- `file_path`: string (path to the markdown file)
- `title`: string (title of the document)
- `checksum`: string (SHA256 hash of the content for change detection)
- `total_chunks`: integer (number of chunks created from this document)
- `word_count`: integer (total word count in the document)
- `created_at`: datetime (timestamp when document was first processed)
- `updated_at`: datetime (timestamp when document was last processed)

**Validation Rules**:
- `file_path` must be a valid markdown file path
- `title` must not be empty
- `checksum` must be a valid SHA256 hash

### 3. ChatSession

**Description**: Represents a conversation session between a user and the AI agent

**Fields**:
- `id`: string (primary key, UUID)
- `user_id`: string (identifier for the user, can be anonymous)
- `session_token`: string (secure session identifier)
- `created_at`: datetime (timestamp when session started)
- `updated_at`: datetime (timestamp of last interaction)
- `is_active`: boolean (whether the session is currently active)
- `metadata`: object (additional session information)

**Validation Rules**:
- `id` must be a valid UUID
- `user_id` can be anonymous identifier
- `is_active` defaults to true

**Relationships**:
- Contains many `ChatMessage` objects
- Associated with many `QueryContext` objects

### 4. ChatMessage

**Description**: Represents a single message in a chat session

**Fields**:
- `id`: string (primary key, UUID)
- `session_id`: string (foreign key to ChatSession)
- `role`: string (either "user" or "assistant")
- `content`: string (the actual message content)
- `timestamp`: datetime (when the message was created)
- `message_type`: string (e.g., "text", "query_with_context", "selected_text_query")
- `context_chunks`: array of strings (Qdrant IDs of chunks used in response)
- `response_time_ms`: integer (time taken to generate response, for metrics)

**Validation Rules**:
- `role` must be either "user" or "assistant"
- `content` must not be empty
- `session_id` must reference an existing session

**Relationships**:
- Belongs to one `ChatSession` (via `session_id`)
- References many `BookContentChunk` objects (via `context_chunks`)

### 5. QueryContext

**Description**: Represents the context used for a specific query, particularly for RAG operations

**Fields**:
- `id`: string (primary key, UUID)
- `session_id`: string (foreign key to ChatSession)
- `query_text`: string (the original query from the user)
- `selected_text`: string (optional, text selected by user for selected-text RAG)
- `retrieved_chunks`: array of strings (Qdrant IDs of retrieved chunks)
- `context_used`: string (concatenated context sent to the LLM)
- `query_timestamp`: datetime (when the query was made)
- `query_type`: string (e.g., "rag_query", "selected_text_query")

**Validation Rules**:
- `query_text` must not be empty
- `query_type` must be one of the allowed values
- `retrieved_chunks` array must contain valid Qdrant IDs when applicable

**Relationships**:
- Belongs to one `ChatSession` (via `session_id`)
- References many `BookContentChunk` objects (via `retrieved_chunks`)

### 6. AgentResponse

**Description**: Represents the response generated by the AI agent

**Fields**:
- `id`: string (primary key, UUID)
- `query_context_id`: string (foreign key to QueryContext)
- `response_content`: string (the generated response)
- `confidence_score`: float (confidence score of the response, 0.0-1.0)
- `sources_used`: array of strings (Qdrant IDs of chunks that influenced the response)
- `generation_time_ms`: integer (time taken to generate the response)
- `model_used`: string (which model was used, e.g., "gemini-pro")
- `response_timestamp`: datetime (when the response was generated)

**Validation Rules**:
- `response_content` must not be empty
- `confidence_score` must be between 0.0 and 1.0
- `model_used` must be a valid model identifier

**Relationships**:
- Belongs to one `QueryContext` (via `query_context_id`)
- References many `BookContentChunk` objects (via `sources_used`)

### 7. EmbeddingJob

**Description**: Represents a job for processing documents and creating embeddings

**Fields**:
- `id`: string (primary key, UUID)
- `status`: string (e.g., "pending", "processing", "completed", "failed")
- `source_path`: string (path to source documents to process)
- `total_documents`: integer (number of documents to process)
- `processed_documents`: integer (number of documents processed)
- `failed_documents`: integer (number of documents that failed)
- `start_time`: datetime (when the job started)
- `end_time`: datetime (when the job completed or failed)
- `error_message`: string (if the job failed, contains error details)
- `metadata`: object (additional job information)

**Validation Rules**:
- `status` must be one of the allowed values
- `total_documents` must be non-negative
- `processed_documents` must not exceed `total_documents`

## State Transitions

### ChatSession States
- `active` → `inactive` (when session times out or user ends session)
- `inactive` → `active` (when user resumes conversation)

### EmbeddingJob States
- `pending` → `processing` (when job starts)
- `processing` → `completed` (when all documents processed successfully)
- `processing` → `failed` (when errors occur during processing)
- `failed` → `pending` (when retrying failed job)

## Indexes and Performance Considerations

### Qdrant Vector Indexes
- Primary vector index on `BookContentChunk.embedding` with cosine distance
- Keyword index on `BookContentChunk.source_file` for filtering by document
- Integer index on `BookContentChunk.chunk_index` for ordering

### Database Indexes (if using traditional DB alongside Qdrant)
- Index on `ChatSession.user_id` for user session lookup
- Index on `ChatMessage.session_id` and `timestamp` for chronological ordering
- Index on `QueryContext.session_id` and `query_timestamp` for session history

## Data Validation

### Content Validation
- All text content should be validated for length limits
- Chunk size should be within reasonable limits (e.g., 100-1000 tokens)
- Source file paths should be validated to prevent directory traversal

### Embedding Validation
- Embedding vectors must have exactly 1024 dimensions (for Cohere)
- Embedding values should be within reasonable ranges
- Duplicate embeddings should be detected and handled

### Session Validation
- Session tokens should be securely generated
- Session timeouts should be enforced
- Rate limiting should be applied per session/user

## Data Lifecycle

### Chunk Lifecycle
1. Document is processed and split into chunks
2. Embeddings are generated for each chunk
3. Chunks are stored in Qdrant with metadata
4. Chunks are retrieved during RAG queries
5. Chunks may be updated when source documents change
6. Chunks are deleted when source documents are removed

### Session Lifecycle
1. New session is created for user interaction
2. Messages are added as conversation progresses
3. Session is marked inactive after timeout
4. Old sessions may be archived or deleted based on retention policy

## Security Considerations

### Data Protection
- Sensitive user information should be encrypted
- Session tokens should be securely generated and stored
- API keys should never be stored in plain text
- Chat history should respect user privacy preferences

### Access Control
- Document access should be validated to prevent unauthorized access
- Embedding jobs should be restricted to authorized users
- API endpoints should have appropriate authentication